const tableName = "ProjectReportsPerPaymentGateways"

const exists = (base: any, projectId: number, pgName: string): Promise<ProjectReportsPerPaymentGateway> => {
  return new Promise(resolve => {
    let ans: ProjectReportsPerPaymentGateway;

    const page = (records: any, fetchNextPage: any) => {
      records.forEach(function (record: any) {
        // console.log('Retrieved', record.fields);
        ans = {
          airtable_id: record.id,
          project: record.get("project"),
          value: record.get("value"),
          pgCompany: record.get("paymentGatewayCompany"),
          unpaid: record.get("unpaid"),
        }
      });
      fetchNextPage();
    }

    const done = (err: any) => {
      if (err) {
        console.error(err);
        return;
      }
      resolve(ans)
    }

    const queryProject = `FIND("${projectId}", ARRAYJOIN({project}, ",")) > 0`
    const queryPg = `FIND("${pgName}", ARRAYJOIN({paymentGatewayCompany}, ",")) > 0`
    // console.log(`AND(${queryProject},${queryPg})`);

    base(tableName).select({
      filterByFormula: `AND(${queryProject},${queryPg})`,
      view: "Grid view"
    }).eachPage(page, done);
  })
}

const update = (base: any, id: string, projectId: string, pgId: string, value: number, unpaid: boolean) => {
  return new Promise(resolve => {
    const content = {
      id,
      fields: {
        value: value,
        project: [projectId],
        paymentGatewayCompany: [pgId],
        unpaid
      }
    }

    base(tableName).update([content], function (err: any) {
      if (err) {
        console.error(err);
        return;
      }
      resolve(true)
    });
  })
}

const create = (base: any, projectId: string, pgId: string, value: number, unpaid: boolean) => {
  return new Promise(resolve => {
    const fields = {
      value,
      project: [projectId],
      paymentGatewayCompany: [pgId],
      unpaid,
    }

    base(tableName).create([{ fields }], function (err: any) {
      if (err) {
        console.error(err);
        return;
      }
      resolve(true)
    });
  })
}
